# 完整示例 - 包含所有功能
# 运行: ./workflow-engine run examples/07-complete.yaml
#
# 本示例综合展示所有功能：
# - 变量和 HTTP 全局配置
# - 钩子 (工作流级和步骤级)
# - 各种 HTTP 方法
# - 条件分支
# - 错误处理
# - 性能配置

id: complete-example
name: 完整示例
description: 综合展示所有功能

# 变量定义
variables:
  api_key: "test-api-key-12345"
  user_id: "user-001"

# HTTP 全局配置
http:
  # 默认域名
  base_url: "https://httpbin.org"

  # 多域名配置
  domains:
    main: "https://httpbin.org"
    auth: "https://httpbin.org"
    upload: "https://httpbin.org"

  # 公共请求头（所有 HTTP 请求都会携带）
  headers:
    X-API-Key: "${api_key}"
    User-Agent: "workflow-engine/1.0"
    Accept: "application/json"

  # SSL 配置
  ssl:
    verify: true

  # 重定向配置
  redirect:
    follow: true
    max_redirects: 5

  # 超时配置
  timeout:
    connect: 10s
    read: 30s
    write: 30s
    request: 60s

# 工作流钩子
pre_hook:
  type: script
  config:
    script: |
      console.log('=== 工作流开始 ===');
      ctx.SetVariable('start_time', Date.now());

post_hook:
  type: script
  config:
    script: |
      const duration = Date.now() - ctx.GetVariable('start_time');
      console.log('=== 工作流完成，耗时: ' + duration + 'ms ===');

# 执行选项
options:
  vus: 5
  iterations: 10
  mode: shared-iterations
  http_engine: fasthttp
  thresholds:
    - metric: http_req_duration
      condition: "p(95) < 500"
    - metric: http_req_failed
      condition: "rate < 0.05"

steps:
  # 健康检查 (使用默认 base_url)
  - id: health_check
    name: 健康检查
    type: http
    config:
      method: GET
      url: "/get"
    pre_hook:
      type: script
      config:
        script: console.log('检查 API 健康状态...');
    on_error: abort
    timeout: 30s

  # 使用指定域名 (auth)
  - id: auth_request
    name: 认证请求
    type: http
    config:
      method: POST
      domain: auth # 使用 auth 域名
      url: "/post"
      headers:
        X-Auth-Token: "bearer-token-12345"
      body: |
        {
          "username": "${user_id}",
          "action": "login"
        }
    on_error: continue
    timeout: 30s

  # 条件判断 - 使用扁平化结构
  - id: check_success
    name: 检查成功
    type: condition
    config:
      type: if # if / else_if / else，默认 if
      expression: "${response.status_code} == 200"
    children:
      - id: log_success
        name: 记录成功
        type: script
        config:
          script: |
            console.log('API 正常');
            ctx.SetVariable('api_healthy', true);

  - id: check_timeout
    name: 检查超时
    type: condition
    config:
      type: else_if
      expression: "${response.status_code} == 408"
    children:
      - id: log_timeout
        name: 记录超时
        type: script
        config:
          script: |
            console.log('请求超时');
            ctx.SetVariable('api_healthy', false);

  - id: handle_error
    name: 处理错误
    type: condition
    config:
      type: else # else 不需要 expression
    children:
      - id: log_failure
        name: 记录失败
        type: script
        config:
          script: |
            console.log('API 异常');
            ctx.SetVariable('api_healthy', false);

  # 创建资源 (使用 main 域名)
  - id: create_resource
    name: 创建资源
    type: http
    config:
      method: POST
      domain: main # 使用 main 域名
      url: "/post"
      headers:
        Content-Type: "application/json"
      body: |
        {
          "name": "test-resource",
          "user_id": "${user_id}"
        }
    on_error: continue
    timeout: 30s

  # 文件上传 (使用 upload 域名)
  - id: upload_file
    name: 文件上传
    type: http
    config:
      method: POST
      domain: upload # 使用 upload 域名
      url: "/post"
      headers:
        Content-Type: "application/octet-stream"
        X-File-Name: "test-file.txt"
      body: "This is test file content"
    on_error: skip
    timeout: 60s

  # 循环处理
  - id: batch_process
    name: 批量处理
    type: loop
    loop:
      mode: for
      count: 3
      steps:
        - id: process_item
          name: 处理项目
          type: script
          config:
            script: |
              console.log('处理第 ' + ctx.GetVariable('loop.iteration') + ' 项');

  # 最终步骤
  - id: final_step
    name: 完成
    type: script
    config:
      script: |
        console.log('所有步骤执行完成');
        console.log('API 健康: ' + ctx.GetVariable('api_healthy'));
