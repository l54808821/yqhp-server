# 完整示例 - 包含所有功能
# 运行: ./workflow-engine run examples/17-complete-example.yaml

id: complete-example
name: Complete Example
description: 展示所有功能的完整工作流示例

# 变量定义
variables:
  api_key: "test-api-key-12345"
  user_id: "user-001"
  timeout_ms: 30000

# HTTP 全局配置
http:
  # 基础 URL（默认域名）
  base_url: "https://httpbin.org"

  # 多域名配置
  domains:
    main: "https://httpbin.org"
    auth: "https://httpbin.org"
    upload: "https://httpbin.org"

  # 公共请求头（所有 HTTP 请求都会携带）
  headers:
    X-API-Key: "${api_key}"
    X-Request-ID: "${__uuid}"
    User-Agent: "workflow-engine/1.0"
    Accept: "application/json"

  # SSL 配置
  ssl:
    verify: true

  # 重定向配置
  redirect:
    follow: true
    max_redirects: 5

  # 超时配置
  timeout:
    connect: 10s
    read: 30s
    write: 30s
    request: 60s

# 工作流前置钩子
pre_hook:
  type: script
  config:
    script: |
      console.log('=== Workflow Starting ===');
      ctx.SetVariable('workflow_start', Date.now());

# 工作流后置钩子
post_hook:
  type: script
  config:
    script: |
      const duration = Date.now() - ctx.GetVariable('workflow_start');
      console.log('=== Workflow Completed in ' + duration + 'ms ===');

# 执行选项
options:
  vus: 5
  iterations: 10
  mode: shared-iterations
  http_engine: fasthttp # 使用 FastHTTP 引擎（默认）
  thresholds:
    - metric: http_req_duration
      condition: "p(95) < 500"
    - metric: http_req_failed
      condition: "rate < 0.05"

# 步骤列表
steps:
  # 步骤 1: 健康检查（使用默认域名）
  - id: health_check
    name: Health Check
    type: http
    config:
      method: GET
      url: "/get" # 使用 base_url
    pre_hook:
      type: script
      config:
        script: |
          console.log('Checking API health...');
    post_hook:
      type: script
      config:
        script: |
          console.log('Health check completed');
    on_error: abort
    timeout: 30s

  # 步骤 2: 使用指定域名（auth）
  - id: auth_request
    name: Auth Request
    type: http
    config:
      method: POST
      domain: auth # 使用 auth 域名
      url: "/post"
      headers:
        # 步骤级 header（会与公共 header 合并，相同 key 会覆盖）
        X-Auth-Token: "bearer-token-12345"
      body: |
        {
          "username": "${user_id}",
          "action": "login"
        }
    on_error: continue
    timeout: 30s

  # 步骤 3: 条件判断
  - id: check_response
    name: Check Response
    type: condition
    condition:
      expression: "${response.status_code} == 200"
      then:
        - id: log_success
          name: Log Success
          type: script
          config:
            script: |
              console.log('API is healthy, proceeding...');
              ctx.SetVariable('api_healthy', true);
      else:
        - id: log_failure
          name: Log Failure
          type: script
          config:
            script: |
              console.log('API is unhealthy!');
              ctx.SetVariable('api_healthy', false);

  # 步骤 4: 创建资源 (POST) - 使用 main 域名
  - id: create_resource
    name: Create Resource
    type: http
    config:
      method: POST
      domain: main
      url: "/post"
      headers:
        Content-Type: "application/json"
        X-User-ID: "${user_id}"
      body: |
        {
          "name": "test-resource",
          "type": "example",
          "metadata": {
            "created_by": "${user_id}",
            "version": "1.0"
          }
        }
    on_error: continue
    timeout: 30s

  # 步骤 5: 更新资源 (PUT)
  - id: update_resource
    name: Update Resource
    type: http
    config:
      method: PUT
      url: "/put"
      headers:
        Content-Type: "application/json"
      body: |
        {
          "name": "updated-resource",
          "status": "active"
        }
    on_error: continue
    timeout: 30s

  # 步骤 6: 部分更新 (PATCH)
  - id: patch_resource
    name: Patch Resource
    type: http
    config:
      method: PATCH
      url: "/patch"
      headers:
        Content-Type: "application/json"
      body: |
        {
          "status": "completed"
        }
    on_error: continue
    timeout: 30s

  # 步骤 7: 查询资源 (GET with query)
  - id: query_resources
    name: Query Resources
    type: http
    config:
      method: GET
      url: "/get"
      params:
        page: "1"
        size: "10"
        sort: "created_at"
        order: "desc"
        filter: "status:active"
    on_error: continue
    timeout: 30s

  # 步骤 8: 文件上传模拟 - 使用 upload 域名
  - id: upload_file
    name: Upload File
    type: http
    config:
      method: POST
      domain: upload
      url: "/post"
      headers:
        Content-Type: "application/octet-stream"
        X-File-Name: "test-file.txt"
      body: "This is test file content"
    on_error: skip
    timeout: 60s

  # 步骤 9: 删除资源 (DELETE)
  - id: delete_resource
    name: Delete Resource
    type: http
    config:
      method: DELETE
      url: "/delete"
    on_error: skip
    timeout: 30s

  # 步骤 10: 最终脚本
  - id: final_script
    name: Final Script
    type: script
    config:
      script: |
        const apiHealthy = ctx.GetVariable('api_healthy');
        console.log('Workflow completed!');
        console.log('API was healthy: ' + apiHealthy);
