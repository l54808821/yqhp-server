# 完整示例 - 包含所有功能
# 运行: ./workflow-engine run examples/17-complete-example.yaml

id: complete-example
name: Complete Example
description: 展示所有功能的完整工作流示例

# 变量定义
variables:
  base_url: "https://httpbin.org"
  api_key: "test-api-key-12345"
  user_id: "user-001"
  timeout_ms: 30000

# 工作流前置钩子
pre_hook:
  type: script
  config:
    script: |
      console.log('=== Workflow Starting ===');
      ctx.SetVariable('workflow_start', Date.now());

# 工作流后置钩子
post_hook:
  type: script
  config:
    script: |
      const duration = Date.now() - ctx.GetVariable('workflow_start');
      console.log('=== Workflow Completed in ' + duration + 'ms ===');

# 执行选项
options:
  vus: 5
  iterations: 10
  mode: shared-iterations
  thresholds:
    - metric: http_req_duration
      condition: "p(95) < 500"
    - metric: http_req_failed
      condition: "rate < 0.05"

# 步骤列表
steps:
  # 步骤 1: 健康检查
  - id: health_check
    name: Health Check
    type: http
    config:
      method: GET
      url: "${base_url}/get"
      headers:
        X-API-Key: "${api_key}"
    pre_hook:
      type: script
      config:
        script: |
          console.log('Checking API health...');
    post_hook:
      type: script
      config:
        script: |
          console.log('Health check completed');
    on_error: abort
    timeout: 30s

  # 步骤 2: 条件判断
  - id: check_response
    name: Check Response
    type: condition
    condition:
      expression: "${response.status_code} == 200"
      then:
        - id: log_success
          name: Log Success
          type: script
          config:
            script: |
              console.log('API is healthy, proceeding...');
              ctx.SetVariable('api_healthy', true);
      else:
        - id: log_failure
          name: Log Failure
          type: script
          config:
            script: |
              console.log('API is unhealthy!');
              ctx.SetVariable('api_healthy', false);

  # 步骤 3: 创建资源 (POST)
  - id: create_resource
    name: Create Resource
    type: http
    config:
      method: POST
      url: "${base_url}/post"
      headers:
        Content-Type: "application/json"
        X-API-Key: "${api_key}"
        X-User-ID: "${user_id}"
      body: |
        {
          "name": "test-resource",
          "type": "example",
          "metadata": {
            "created_by": "${user_id}",
            "version": "1.0"
          }
        }
    on_error: continue
    timeout: 30s

  # 步骤 4: 更新资源 (PUT)
  - id: update_resource
    name: Update Resource
    type: http
    config:
      method: PUT
      url: "${base_url}/put"
      headers:
        Content-Type: "application/json"
        X-API-Key: "${api_key}"
      body: |
        {
          "name": "updated-resource",
          "status": "active"
        }
    on_error: continue
    timeout: 30s

  # 步骤 5: 部分更新 (PATCH)
  - id: patch_resource
    name: Patch Resource
    type: http
    config:
      method: PATCH
      url: "${base_url}/patch"
      headers:
        Content-Type: "application/json"
        X-API-Key: "${api_key}"
      body: |
        {
          "status": "completed"
        }
    on_error: continue
    timeout: 30s

  # 步骤 6: 查询资源 (GET with query)
  - id: query_resources
    name: Query Resources
    type: http
    config:
      method: GET
      url: "${base_url}/get"
      headers:
        X-API-Key: "${api_key}"
      query:
        page: 1
        size: 10
        sort: "created_at"
        order: "desc"
        filter: "status:active"
    on_error: continue
    timeout: 30s

  # 步骤 7: 删除资源 (DELETE)
  - id: delete_resource
    name: Delete Resource
    type: http
    config:
      method: DELETE
      url: "${base_url}/delete"
      headers:
        X-API-Key: "${api_key}"
    on_error: skip
    timeout: 30s

  # 步骤 8: 最终脚本
  - id: final_script
    name: Final Script
    type: script
    config:
      script: |
        const apiHealthy = ctx.GetVariable('api_healthy');
        console.log('Workflow completed!');
        console.log('API was healthy: ' + apiHealthy);
